<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Tables Magiques</title>
  <meta name="theme-color" content="#7c3aed" />
  <style>
    :root{
      --bg1:#f7f7ff;
      --bg2:#fff7ed;
      --ink:#1f2937;
      --muted:#6b7280;
      --primary:#7c3aed;
      --cyan:#06b6d4;
      --good:#22c55e;
      --bad:#ef4444;
      --shadow: 0 12px 26px rgba(31,41,55,.12);
      --radius: 20px;
    }
    *{box-sizing:border-box}
    html, body{height:100%}
    body{
      margin:0;
      font-family: ui-rounded, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      color:var(--ink);
      background:
        radial-gradient(900px 600px at 20% 10%, rgba(124,58,237,.20), transparent 60%),
        radial-gradient(900px 600px at 90% 30%, rgba(6,182,212,.18), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      padding:
        calc(10px + env(safe-area-inset-top))
        10px
        calc(10px + env(safe-area-inset-bottom))
        10px;

      /* IMPORTANT: pas de scroll global */
      overflow: hidden;
    }

    /* App full height without scroll */
    .app{
      height: calc(100dvh - 20px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
      max-height: calc(100vh - 20px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
      width:min(820px, 100%);
      margin:0 auto;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .topbar{
      flex:0 0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-radius: var(--radius);
      background: rgba(255,255,255,.70);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      border: 1px solid rgba(31,41,55,.08);
    }

    .brand{display:flex; gap:10px; align-items:center; min-width:0;}
    .logo{
      width:38px; height:38px; border-radius:14px; display:grid; place-items:center;
      background: linear-gradient(135deg, rgba(124,58,237,.95), rgba(6,182,212,.9));
      color:white; box-shadow: 0 12px 20px rgba(124,58,237,.22);
      flex:0 0 auto; font-size:18px;
    }
    .brand h1{
      margin:0; font-size:16px; line-height:1.1;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .brand p{
      margin:2px 0 0; font-size:12px; color:var(--muted);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .btn{
      border:0; cursor:pointer; border-radius: 16px; padding: 10px 12px;
      font-weight: 900; font-size: 14px;
      user-select:none; -webkit-tap-highlight-color: transparent;
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(31,41,55,.10);
      color: var(--ink);
      box-shadow: none;
    }
    .btn:active{transform: translateY(1px);}
    .btn.primary{
      color:white;
      border:none;
      background: linear-gradient(180deg, rgba(124,58,237,.98), rgba(124,58,237,.82));
      box-shadow: 0 10px 18px rgba(124,58,237,.18);
    }
    .btn.danger{
      background: rgba(239,68,68,.12);
      color: #991b1b;
      border: 1px solid rgba(239,68,68,.18);
    }
    .btn.icon{display:flex; align-items:center; gap:8px;}

    /* Main quiz card takes all space */
    .quizCard{
      flex: 1 1 auto;
      min-height: 0; /* allow internal fit */
      border-radius: var(--radius);
      background: rgba(255,255,255,.75);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(31,41,55,.08);
      box-shadow: var(--shadow);
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .quizTop{
      display:flex; gap:8px; justify-content:space-between;
      flex-wrap:wrap; align-items:center;
      flex:0 0 auto;
    }

    .pill{
      padding: 7px 9px; border-radius: 999px;
      background: rgba(6,182,212,.12);
      border: 1px solid rgba(6,182,212,.22);
      font-weight:900; font-size: 12px;
    }

    .questionBox{
      flex: 1 1 auto;
      min-height: 0;
      display:flex;
      flex-direction:column;
      justify-content:center;
      text-align:center;
      padding: 10px;
      border-radius: var(--radius);
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(31,41,55,.08);
    }
    .helper{font-size: 12px; color: var(--muted); margin: 0;}
    .question{
      font-size: clamp(34px, 7vw, 52px);
      font-weight: 1000;
      letter-spacing: .5px;
      margin: 6px 0 2px;
    }

    .answerRow{
      flex:0 0 auto;
      display:flex; gap:8px; align-items:stretch;
    }
    input[type="number"]{
      flex: 1;
      border-radius: 16px;
      border: 1px solid rgba(31,41,55,.12);
      background: rgba(255,255,255,.98);
      padding: 14px 12px;
      font-size: 18px; /* avoid iOS zoom */
      font-weight: 1000;
      text-align:center;
      outline:none;
    }

    .feedback{
      flex:0 0 auto;
      text-align:center;
      min-height: 26px;
      font-weight: 1000;
      font-size: 16px;
      margin-top: 2px;
    }
    .feedback.good{color: var(--good);}
    .feedback.bad{color: var(--bad);}

    .badgeBox{
      flex:0 0 auto;
      padding:10px;
      border-radius:18px;
      border:1px dashed rgba(124,58,237,.35);
      background: rgba(124,58,237,.10);
      text-align:center;
      display:none;
    }
    .badgeBox .big{font-size:34px; font-weight:1000; margin:0}
    .badgeBox .txt{margin:4px 0 0; font-weight:1000}

    .stats{
      flex:0 0 auto;
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:8px;
    }
    @media (max-width:560px){
      .stats{grid-template-columns: repeat(2, 1fr);}
    }
    .stat{
      background: rgba(255,255,255,.9);
      border: 1px solid rgba(31,41,55,.08);
      border-radius: 16px;
      padding: 8px 8px;
      text-align:center;
    }
    .stat .n{font-weight:1000; font-size: 18px;}
    .stat .t{font-size: 12px; color: var(--muted); font-weight: 900;}

    /* Bottom bar: no scrolling, always visible */
    .bottomBar{
      flex:0 0 auto;
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:space-between;
      padding:10px 12px;
      border-radius: var(--radius);
      background: rgba(255,255,255,.78);
      backdrop-filter: blur(10px);
      border:1px solid rgba(31,41,55,.08);
      box-shadow: var(--shadow);
    }
    .barLeft{display:flex; gap:8px; align-items:center; min-width:0; flex:1 1 auto;}
    .barRight{display:flex; gap:8px; align-items:center; flex:0 0 auto;}
    select{
      border-radius: 16px;
      border: 1px solid rgba(31,41,55,.12);
      background: rgba(255,255,255,.98);
      padding: 10px 10px;
      font-size: 16px; /* avoid iOS zoom */
      outline:none;
      max-width: 100%;
    }
    .smallSelect{max-width: 210px;}
    @media (max-width:560px){
      .smallSelect{max-width: 160px;}
    }

    /* Modals */
    .modalBack{
      position:fixed; inset:0;
      background: rgba(15,23,42,.38);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 12px;
      padding-bottom: calc(12px + env(safe-area-inset-bottom));
      z-index: 50;
    }
    .modal{
      width:min(820px, 100%);
      max-height: 85dvh;
      overflow:auto;
      border-radius: 22px;
      background: rgba(255,255,255,.94);
      border:1px solid rgba(31,41,55,.12);
      box-shadow: 0 26px 60px rgba(0,0,0,.20);
      padding: 12px;
    }
    .modalTop{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      position: sticky; top: 0;
      background: rgba(255,255,255,.94);
      backdrop-filter: blur(6px);
      padding: 8px 0;
      border-bottom: 1px solid rgba(31,41,55,.10);
      margin-bottom: 10px;
    }
    .modal h2{margin:0; font-size:16px;}
    .sectionTitle{margin:14px 0 8px; font-weight:1000;}
    .toggleRow{display:flex; gap:10px; flex-wrap:wrap;}
    .toggle{
      display:flex; align-items:center; gap:10px; padding: 10px 12px;
      border-radius: 16px; border: 1px solid rgba(31,41,55,.10);
      background: rgba(255,255,255,.92);
      user-select:none;
    }
    .toggle input{width:18px; height:18px}

    .chips{display:flex; flex-wrap:wrap; gap:8px;}
    .chip{
      padding: 10px 12px; border-radius: 999px;
      border: 1px solid rgba(31,41,55,.10);
      background: rgba(255,255,255,.92);
      font-weight: 900; cursor:pointer;
      user-select:none; -webkit-tap-highlight-color: transparent;
    }
    .chip.on{border-color: rgba(124,58,237,.35); background: rgba(124,58,237,.12);}

    table{width:100%; border-collapse: collapse; font-size: 13px;}
    th, td{padding:10px 8px; border-bottom:1px solid rgba(31,41,55,.10); text-align:left;}
    th{font-size:12px; color: var(--muted);}
    .small{font-size:12px; color: var(--muted);}

    .kpiRow{display:grid; grid-template-columns: repeat(3, 1fr); gap:10px;}
    @media (max-width:560px){ .kpiRow{grid-template-columns: 1fr;} }
    .kpi{
      background: rgba(255,255,255,.95);
      border:1px solid rgba(31,41,55,.10);
      border-radius: 18px;
      padding: 10px;
    }
    .kpi .n{font-weight:1000; font-size:18px;}
    .kpi .t{font-size:12px; color: var(--muted); font-weight:900;}
  </style>
</head>

<body>
  <div class="app">

    <div class="topbar">
      <div class="brand">
        <div class="logo">‚ú®</div>
        <div style="min-width:0">
          <h1>Tables Magiques</h1>
          <p>10 questions ‚Ä¢ √ó1 √† √ó10 ‚Ä¢ sans doublons</p>
        </div>
      </div>
      <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
        <button class="btn icon" id="parentsBtn">üë®‚Äçüë©‚Äçüëß</button>
        <button class="btn icon" id="settingsBtn">‚öôÔ∏è</button>
        <button class="btn icon" id="resetBtn">üßπ</button>
      </div>
    </div>

    <div class="quizCard" id="quizCard">
      <div class="quizTop">
        <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center">
          <span class="pill">üìò <span id="qIndex">0</span>/<span id="qTotal">0</span></span>
          <span class="pill">‚è±Ô∏è <span id="timeLeft">‚Äî</span></span>
          <span class="pill">‚≠ê <span id="streak">0</span></span>
          <span class="pill" id="sessionInfo">‚Äî</span>
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap">
          <button class="btn icon" id="skipBtn">‚û°Ô∏è</button>
          <button class="btn danger icon" id="stopBtn">üõë</button>
        </div>
      </div>

      <div class="questionBox">
        <p class="helper" id="helperText">Choisis un mode en bas puis D√©marrer üöÄ</p>
        <div class="question" id="question">‚Äî</div>
      </div>

      <div class="answerRow">
        <input id="answer" type="number" inputmode="numeric" pattern="[0-9]*" placeholder="Ta r√©ponse" />
        <button class="btn primary icon" id="okBtn">‚úÖ</button>
        <button class="btn icon" id="micBtn" style="display:none" title="Parler">üéôÔ∏è</button>
      </div>

      <div class="feedback" id="feedback"></div>

      <div class="badgeBox" id="badgeBox">
        <p class="big">üèÖ</p>
        <p class="txt">Badge gagn√© : 10/10 !</p>
        <p class="small" style="margin:6px 0 0;">Trop fort(e) üòÑ</p>
      </div>

      <div class="stats">
        <div class="stat"><div class="n" id="good">0</div><div class="t">Justes ‚úÖ</div></div>
        <div class="stat"><div class="n" id="bad">0</div><div class="t">Fausses ‚ùå</div></div>
        <div class="stat"><div class="n" id="accuracy">0%</div><div class="t">R√©ussite üéØ</div></div>
        <div class="stat"><div class="n" id="mistakesCount">0</div><div class="t">Erreurs üß†</div></div>
      </div>
    </div>

    <!-- Bottom bar: always visible, no scrolling -->
    <div class="bottomBar">
      <div class="barLeft">
        <select id="modeSel" class="smallSelect" title="Mode">
          <option value="mix" selected>üé≤ M√©lange</option>
          <option value="choose">üéØ Une table</option>
          <option value="mistakes">üß† Erreurs</option>
        </select>

        <select id="timerSel" class="smallSelect" title="Chrono">
          <option value="off" selected>‚è≥ Chrono OFF</option>
          <option value="15">‚è±Ô∏è 15s</option>
          <option value="10">‚è±Ô∏è 10s</option>
          <option value="5">‚è±Ô∏è 5s</option>
        </select>
      </div>

      <div class="barRight">
        <button class="btn primary icon" id="startBtn">üöÄ</button>
      </div>
    </div>

  </div>

  <!-- Settings modal -->
  <div class="modalBack" id="settingsBack" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="R√©glages">
      <div class="modalTop">
        <h2>‚öôÔ∏è R√©glages</h2>
        <button class="btn icon" id="closeSettingsBtn">‚úñÔ∏è</button>
      </div>

      <div class="toggleRow">
        <div class="toggle">
          <input id="ttsToggle" type="checkbox" />
          <div><b>üîä Lecture</b><br><span class="small">Lire la question</span></div>
        </div>

        <div class="toggle">
          <input id="sttToggle" type="checkbox" />
          <div><b>üéôÔ∏è R√©ponse</b><br><span class="small">Dire le r√©sultat</span></div>
        </div>

        <div class="toggle">
          <input id="hapticToggle" type="checkbox" checked />
          <div><b>üì≥ Vibration</b><br><span class="small">Feedback</span></div>
        </div>
      </div>

      <div class="sectionTitle">Tables (pour ‚ÄúUne table‚Äù)</div>
      <div class="small">Si plusieurs coch√©es, l‚Äôapp en choisit une au hasard.</div>
      <div class="chips" id="tablesGrid" style="margin-top:10px"></div>

      <div class="sectionTitle">Voix</div>
      <div class="small" id="voiceSupport"></div>
    </div>
  </div>

  <!-- Parents modal -->
  <div class="modalBack" id="parentsBack" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Parents">
      <div class="modalTop">
        <h2>üë®‚Äçüë©‚Äçüëß Parents</h2>
        <button class="btn icon" id="closeParentsBtn">‚úñÔ∏è</button>
      </div>

      <div class="kpiRow">
        <div class="kpi">
          <div class="n" id="kpiBadges">0</div>
          <div class="t">Badges üèÖ (10/10)</div>
        </div>
        <div class="kpi">
          <div class="n" id="kpiTotalSessions">0</div>
          <div class="t">Sessions</div>
        </div>
        <div class="kpi">
          <div class="n" id="kpiGlobalAccuracy">0%</div>
          <div class="t">R√©ussite globale</div>
        </div>
      </div>

      <div class="sectionTitle">Progr√®s par table (sur le premier nombre)</div>
      <table>
        <thead><tr><th>Table</th><th>R√©ussite</th><th>Bon / Total</th></tr></thead>
        <tbody id="tablesStatsBody"></tbody>
      </table>

      <div class="sectionTitle">Derni√®res sessions</div>
      <table>
        <thead><tr><th>Date</th><th>Mode</th><th>Infos</th><th>Score</th></tr></thead>
        <tbody id="sessionsBody"></tbody>
      </table>

      <div class="small" style="margin-top:10px;">
        ‚ÄúUne table‚Äù = exactement √ó1 √† √ó10 (sans doublons), id√©al pour apprendre.
      </div>
    </div>
  </div>

<script>
  // ------------------------------
  // Constantes
  // ------------------------------
  const MAX_MUL = 10;
  const QUESTION_COUNT = 10;

  // ------------------------------
  // Storage
  // ------------------------------
  const STORE_KEY = "tablesMagiques_mobile_v1";
  const defaultStore = {
    totalGood: 0,
    totalBad: 0,
    mistakes: {},     // key "a x b" => count (we use "aXb" format)
    badges: 0,
    tables: {},       // per table: { [a]: {good,total} }
    sessions: [],     // last 10
    sessionsEver: 0
  };

  const loadStore = () => { try { return JSON.parse(localStorage.getItem(STORE_KEY)) || null; } catch { return null; } };
  const saveStore = (s) => localStorage.setItem(STORE_KEY, JSON.stringify(s));
  let store = loadStore() || structuredClone(defaultStore);

  // ------------------------------
  // UI refs
  // ------------------------------
  const modeSel = document.getElementById("modeSel");
  const timerSel = document.getElementById("timerSel");

  const startBtn = document.getElementById("startBtn");
  const resetBtn = document.getElementById("resetBtn");
  const settingsBtn = document.getElementById("settingsBtn");
  const parentsBtn = document.getElementById("parentsBtn");

  const qIndexEl = document.getElementById("qIndex");
  const qTotalEl = document.getElementById("qTotal");
  const timeLeftEl = document.getElementById("timeLeft");
  const questionEl = document.getElementById("question");
  const helperText = document.getElementById("helperText");
  const sessionInfo = document.getElementById("sessionInfo");

  const answerEl = document.getElementById("answer");
  const okBtn = document.getElementById("okBtn");
  const skipBtn = document.getElementById("skipBtn");
  const stopBtn = document.getElementById("stopBtn");
  const micBtn = document.getElementById("micBtn");

  const feedbackEl = document.getElementById("feedback");
  const badgeBox = document.getElementById("badgeBox");

  const goodEl = document.getElementById("good");
  const badEl = document.getElementById("bad");
  const streakEl = document.getElementById("streak");
  const accuracyEl = document.getElementById("accuracy");
  const mistakesCountEl = document.getElementById("mistakesCount");

  // Settings modal
  const settingsBack = document.getElementById("settingsBack");
  const closeSettingsBtn = document.getElementById("closeSettingsBtn");
  const ttsToggle = document.getElementById("ttsToggle");
  const sttToggle = document.getElementById("sttToggle");
  const hapticToggle = document.getElementById("hapticToggle");
  const tablesGrid = document.getElementById("tablesGrid");
  const voiceSupportEl = document.getElementById("voiceSupport");

  // Parents modal
  const parentsBack = document.getElementById("parentsBack");
  const closeParentsBtn = document.getElementById("closeParentsBtn");
  const kpiBadges = document.getElementById("kpiBadges");
  const kpiTotalSessions = document.getElementById("kpiTotalSessions");
  const kpiGlobalAccuracy = document.getElementById("kpiGlobalAccuracy");
  const tablesStatsBody = document.getElementById("tablesStatsBody");
  const sessionsBody = document.getElementById("sessionsBody");

  // ------------------------------
  // Utils
  // ------------------------------
  function randInt(min, max){ return Math.floor(Math.random()*(max-min+1))+min; }
  function shuffle(arr){
    for (let i=arr.length-1; i>0; i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }
  function pairKey(a,b){ return `${a}x${b}`; }
  function fmtDate(ts){
    const d = new Date(ts);
    return d.toLocaleDateString("fr-FR", { day:"2-digit", month:"2-digit" }) + " " +
           d.toLocaleTimeString("fr-FR", { hour:"2-digit", minute:"2-digit" });
  }

  // ------------------------------
  // Haptics
  // ------------------------------
  function haptic(ms){
    if (!hapticToggle.checked) return;
    if (navigator.vibrate) navigator.vibrate(ms);
  }
  function tinyHaptic(){ haptic(10); }
  function goodHaptic(){ haptic(25); }
  function badHaptic(){ haptic([30, 40, 30]); }

  // ------------------------------
  // Tables selection (for "Une table")
  // ------------------------------
  const selectedTables = new Set([2,3,4,5]);
  function renderTables(){
    tablesGrid.innerHTML = "";
    for (let t=1; t<=MAX_MUL; t++){
      const chip = document.createElement("div");
      chip.className = "chip" + (selectedTables.has(t) ? " on" : "");
      chip.textContent = "√ó" + t;
      chip.onclick = () => {
        if (selectedTables.has(t)) selectedTables.delete(t); else selectedTables.add(t);
        renderTables();
        tinyHaptic();
      };
      tablesGrid.appendChild(chip);
    }
  }
  renderTables();

  // ------------------------------
  // Voice: TTS
  // ------------------------------
  function canTTS(){ return "speechSynthesis" in window; }
  function speak(text){
    if (!ttsToggle.checked) return;
    if (!canTTS()) return;
    try{
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "fr-FR";
      u.rate = 0.95;
      u.pitch = 1.05;
      window.speechSynthesis.speak(u);
    }catch{}
  }

  // ------------------------------
  // Voice: STT
  // ------------------------------
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  function canSTT(){ return !!SpeechRecognition; }
  let rec = null;
  function setupRecognition(){
    if (!canSTT()) return null;
    const r = new SpeechRecognition();
    r.lang = "fr-FR";
    r.interimResults = false;
    r.maxAlternatives = 1;
    return r;
  }
  rec = setupRecognition();

  function parseSpokenNumber(frText){
    if (!frText) return null;
    const s = frText.toLowerCase().trim();
    const m = s.match(/\d+/);
    if (m) return parseInt(m[0], 10);

    const map = {
      "z√©ro":0,"zero":0,"un":1,"une":1,"deux":2,"trois":3,"quatre":4,"cinq":5,"six":6,"sept":7,"huit":8,"neuf":9,"dix":10,
      "onze":11,"douze":12,"treize":13,"quatorze":14,"quinze":15,"seize":16,
      "vingt":20,"trente":30,"quarante":40,"cinquante":50,"soixante":60,
      "quatre-vingt":80,"quatre-vingts":80,"cent":100
    };
    const tokens = s.replace(/-/g," ").split(/\s+/).filter(Boolean);
    let current = 0;
    let seen = false;
    for (const tok of tokens){
      if (tok === "et") continue;
      if (map[tok] == null) continue;
      seen = true;
      current += map[tok];
    }
    return seen ? current : null;
  }

  function startListening(){
    if (!sttToggle.checked) return;
    if (!rec) return;
    micBtn.disabled = true;
    micBtn.textContent = "‚Ä¶";
    try{
      rec.onresult = (e) => {
        const said = e.results?.[0]?.[0]?.transcript || "";
        const num = parseSpokenNumber(said);
        if (num != null){
          answerEl.value = String(num);
          okBtn.click();
        } else {
          showFeedback("Je n'ai pas compris üòÖ", "bad");
        }
      };
      rec.onerror = () => showFeedback("Micro indisponible", "bad");
      rec.onend = () => {
        micBtn.disabled = false;
        micBtn.textContent = "üéôÔ∏è";
      };
      rec.start();
    }catch{
      micBtn.disabled = false;
      micBtn.textContent = "üéôÔ∏è";
    }
  }

  function refreshVoiceSupport(){
    const supports = [];
    if (canTTS()) supports.push("üîä Lecture OK");
    else supports.push("üîä Lecture non dispo");
    if (canSTT()) supports.push("üéôÔ∏è Micro OK");
    else supports.push("üéôÔ∏è Micro non dispo");
    voiceSupportEl.textContent = supports.join(" ‚Ä¢ ");
  }
  refreshVoiceSupport();

  // ------------------------------
  // Mistakes
  // ------------------------------
  function mistakesKeys(){ return Object.keys(store.mistakes || {}); }
  function updateMistakesCount(){ mistakesCountEl.textContent = mistakesKeys().length; }
  function addMistake(a,b){
    const key = pairKey(a,b);
    store.mistakes[key] = (store.mistakes[key] || 0) + 1;
  }
  function softenMistake(a,b){
    const key = pairKey(a,b);
    if (store.mistakes[key]){
      store.mistakes[key] -= 1;
      if (store.mistakes[key] <= 0) delete store.mistakes[key];
    }
  }

  // ------------------------------
  // Per-table stats
  // ------------------------------
  function ensureTableStat(a){
    store.tables ||= {};
    store.tables[a] ||= {good:0, total:0};
    return store.tables[a];
  }
  function recordTableResult(a, isGood){
    const t = ensureTableStat(a);
    t.total += 1;
    if (isGood) t.good += 1;
  }

  // ------------------------------
  // Quiz
  // ------------------------------
  let quiz = null; // {items,i,good,bad,streak,timerSec,tLeft,tId,meta}
  function updateStats(){
    if (!quiz){
      goodEl.textContent = "0";
      badEl.textContent = "0";
      streakEl.textContent = "0";
      accuracyEl.textContent = "0%";
      return;
    }
    goodEl.textContent = quiz.good;
    badEl.textContent = quiz.bad;
    streakEl.textContent = quiz.streak;
    const total = quiz.good + quiz.bad;
    const acc = total ? Math.round((quiz.good/total)*100) : 0;
    accuracyEl.textContent = acc + "%";
  }
  function showFeedback(text, kind){
    feedbackEl.textContent = text;
    feedbackEl.className = "feedback " + (kind || "");
  }
  function clearTimer(){
    if (quiz?.tId) clearInterval(quiz.tId);
    if (quiz) quiz.tId = null;
  }
  function setupTimer(){
    clearTimer();
    if (!quiz) return;
    if (quiz.timerSec == null){ timeLeftEl.textContent = "‚Äî"; return; }
    quiz.tLeft = quiz.timerSec;
    timeLeftEl.textContent = quiz.tLeft + "s";
    quiz.tId = setInterval(() => {
      quiz.tLeft -= 1;
      timeLeftEl.textContent = quiz.tLeft + "s";
      if (quiz.tLeft <= 0){
        clearTimer();
        grade(null, true);
      }
    }, 1000);
  }

  // NO DUPLICATES
  function makeQuestions(){
    const mode = modeSel.value;

    // "Une table" = une table au hasard parmi coch√©es, avec b=1..10 une seule fois
    if (mode === "choose"){
      const allowed = [...selectedTables];
      const chosen = allowed.length ? allowed[randInt(0, allowed.length-1)] : 2;
      const bs = shuffle(Array.from({length: MAX_MUL}, (_,i)=>i+1)); // 1..10 shuffled
      const items = bs.map(b => ({a: chosen, b}));
      return { items, info: `Table √ó${chosen}`, modeLabel: "Une table" };
    }

    // "M√©lange" = 10 paires uniques
    if (mode === "mix"){
      const used = new Set();
      const items = [];
      while (items.length < QUESTION_COUNT){
        const a = randInt(1, MAX_MUL);
        const b = randInt(1, MAX_MUL);
        const k = pairKey(a,b);
        if (used.has(k)) continue;
        used.add(k);
        items.push({a,b});
      }
      return { items, info: "M√©lange", modeLabel: "M√©lange" };
    }

    // "Erreurs" = erreurs uniques d'abord, puis compl√®te avec uniques
    const keys = mistakesKeys()
      .map(k => ({k, w: store.mistakes[k] || 1}))
      .sort((x,y)=> y.w - x.w);

    const used = new Set();
    const items = [];
    for (const obj of keys){
      if (items.length >= QUESTION_COUNT) break;
      const [aS,bS] = obj.k.split("x");
      const a = parseInt(aS,10), b = parseInt(bS,10);
      if (a<1 || a>MAX_MUL || b<1 || b>MAX_MUL) continue;
      const k = pairKey(a,b);
      if (used.has(k)) continue;
      used.add(k);
      items.push({a,b});
    }
    while (items.length < QUESTION_COUNT){
      const a = randInt(1, MAX_MUL);
      const b = randInt(1, MAX_MUL);
      const k = pairKey(a,b);
      if (used.has(k)) continue;
      used.add(k);
      items.push({a,b});
    }
    return { items, info: "Erreurs", modeLabel: "Erreurs" };
  }

  function renderQuestion(){
    const it = quiz.items[quiz.i];
    qIndexEl.textContent = (quiz.i + 1);
    qTotalEl.textContent = quiz.items.length;
    questionEl.textContent = `${it.a} √ó ${it.b} = ?`;
    helperText.textContent = sttToggle.checked ? "Tu peux parler ou √©crire !" : "√âcris ta r√©ponse üòÑ";
    answerEl.value = "";
    showFeedback("", "");
    badgeBox.style.display = "none";
    updateStats();
    setupTimer();
    speak(`${it.a} fois ${it.b}.`);
    setTimeout(() => answerEl.focus({preventScroll:true}), 0);
  }

  function endQuiz(){
    clearTimer();
    const total = quiz.good + quiz.bad;
    const acc = total ? Math.round((quiz.good/total)*100) : 0;
    const gotBadge = (quiz.good === QUESTION_COUNT);

    if (gotBadge){
      store.badges = (store.badges || 0) + 1;
      badgeBox.style.display = "block";
      speak("Bravo ! Badge gagn√© !");
    } else {
      speak("Bravo !");
    }

    store.sessionsEver = (store.sessionsEver || 0) + 1;
    store.sessions ||= [];
    store.sessions.unshift({
      ts: Date.now(),
      mode: quiz.meta.modeLabel,
      info: quiz.meta.info,
      good: quiz.good,
      total: QUESTION_COUNT,
      badge: gotBadge
    });
    store.sessions = store.sessions.slice(0, 10);

    saveStore(store);

    questionEl.textContent = "Bravo üéâ";
    helperText.textContent = gotBadge ? "Tu as gagn√© un badge üèÖ !" : "Recommence quand tu veux üòÑ";
    showFeedback(`Score : ${quiz.good}/${total} (${acc}%)`, "");
    timeLeftEl.textContent = "‚Äî";
    qIndexEl.textContent = total;
    qTotalEl.textContent = total;
    sessionInfo.textContent = quiz.meta.info;

    quiz = null;
    updateStats();
    updateMistakesCount();
    refreshParentsUI();
  }

  function grade(value, timeout=false){
    if (!quiz) return;
    clearTimer();

    const it = quiz.items[quiz.i];
    const correct = it.a * it.b;
    const ok = (value !== null && Number(value) === correct);

    recordTableResult(it.a, ok);

    if (ok){
      quiz.good++; quiz.streak++;
      store.totalGood++;
      softenMistake(it.a, it.b);
      showFeedback("‚úÖ Super !", "good");
      goodHaptic();
      speak("Bravo !");
    } else {
      quiz.bad++; quiz.streak = 0;
      store.totalBad++;
      addMistake(it.a, it.b);
      showFeedback(timeout ? `‚è±Ô∏è Trop tard‚Ä¶ ${correct}` : `‚ùå Oups‚Ä¶ ${correct}`, "bad");
      badHaptic();
      speak(`C'√©tait ${correct}.`);
    }

    saveStore(store);
    updateMistakesCount();
    updateStats();

    setTimeout(() => {
      quiz.i++;
      if (quiz.i >= quiz.items.length) endQuiz();
      else renderQuestion();
    }, 520);
  }

  function startQuiz(){
    badgeBox.style.display = "none";
    micBtn.style.display = sttToggle.checked ? "inline-flex" : "none";

    const timerVal = timerSel.value === "off" ? null : parseInt(timerSel.value, 10);
    const gen = makeQuestions();

    quiz = {
      items: gen.items,
      i: 0,
      good: 0,
      bad: 0,
      streak: 0,
      timerSec: timerVal,
      tLeft: null,
      tId: null,
      meta: { modeLabel: gen.modeLabel, info: gen.info }
    };

    sessionInfo.textContent = gen.info;
    tinyHaptic();
    renderQuestion();
  }

  function stopQuiz(){
    clearTimer();
    quiz = null;
    qIndexEl.textContent = "0";
    qTotalEl.textContent = "0";
    timeLeftEl.textContent = "‚Äî";
    questionEl.textContent = "‚Äî";
    helperText.textContent = "Choisis un mode en bas puis D√©marrer üöÄ";
    sessionInfo.textContent = "‚Äî";
    answerEl.value = "";
    showFeedback("", "");
    badgeBox.style.display = "none";
    updateStats();
  }

  // ------------------------------
  // Parents UI
  // ------------------------------
  function refreshParentsUI(){
    const totalAnswers = (store.totalGood || 0) + (store.totalBad || 0);
    const globalAcc = totalAnswers ? Math.round((store.totalGood / totalAnswers) * 100) : 0;

    kpiBadges.textContent = store.badges || 0;
    kpiTotalSessions.textContent = store.sessionsEver || 0;
    kpiGlobalAccuracy.textContent = globalAcc + "%";

    tablesStatsBody.innerHTML = "";
    for (let a=1; a<=MAX_MUL; a++){
      const t = (store.tables && store.tables[a]) ? store.tables[a] : {good:0, total:0};
      const pct = t.total ? Math.round((t.good / t.total) * 100) : 0;
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>√ó${a}</td><td>${t.total ? (pct + "%") : "‚Äî"}</td><td>${t.good} / ${t.total}</td>`;
      tablesStatsBody.appendChild(tr);
    }

    sessionsBody.innerHTML = "";
    const list = store.sessions || [];
    if (list.length === 0){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="4" class="small">Aucune session enregistr√©e pour l‚Äôinstant.</td>`;
      sessionsBody.appendChild(tr);
    } else {
      for (const s of list){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${fmtDate(s.ts)}</td>
          <td>${s.mode}</td>
          <td>${s.info} ${s.badge ? "üèÖ" : ""}</td>
          <td>${s.good}/${s.total}</td>
        `;
        sessionsBody.appendChild(tr);
      }
    }
  }

  // ------------------------------
  // Modals
  // ------------------------------
  function openModal(backEl){ backEl.style.display = "flex"; backEl.setAttribute("aria-hidden","false"); }
  function closeModal(backEl){ backEl.style.display = "none"; backEl.setAttribute("aria-hidden","true"); }

  // ------------------------------
  // Events
  // ------------------------------
  startBtn.addEventListener("click", startQuiz);

  okBtn.addEventListener("click", () => {
    if (!quiz) return;
    const v = answerEl.value.trim();
    if (!v) return;
    grade(v, false);
  });

  skipBtn.addEventListener("click", () => { if (quiz) grade(null, false); });
  stopBtn.addEventListener("click", stopQuiz);
  answerEl.addEventListener("keydown", (e) => { if (e.key === "Enter") okBtn.click(); });

  micBtn.addEventListener("click", startListening);
  sttToggle.addEventListener("change", () => { micBtn.style.display = sttToggle.checked ? "inline-flex" : "none"; });

  resetBtn.addEventListener("click", () => {
    store = structuredClone(defaultStore);
    saveStore(store);
    refreshParentsUI();
    updateMistakesCount();
    stopQuiz();
    alert("Tout est remis √† z√©ro ‚úÖ");
  });

  settingsBtn.addEventListener("click", () => { refreshVoiceSupport(); openModal(settingsBack); });
  closeSettingsBtn.addEventListener("click", () => closeModal(settingsBack));
  settingsBack.addEventListener("click", (e) => { if (e.target === settingsBack) closeModal(settingsBack); });

  parentsBtn.addEventListener("click", () => { refreshParentsUI(); openModal(parentsBack); });
  closeParentsBtn.addEventListener("click", () => closeModal(parentsBack));
  parentsBack.addEventListener("click", (e) => { if (e.target === parentsBack) closeModal(parentsBack); });

  // ------------------------------
  // Init
  // ------------------------------
  function init(){
    refreshParentsUI();
    updateMistakesCount();
    stopQuiz();
    micBtn.style.display = sttToggle.checked ? "inline-flex" : "none";
  }
  init();
</script>
</body>
</html>
